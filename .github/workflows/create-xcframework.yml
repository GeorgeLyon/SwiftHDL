name: Create and Test XCFramework

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

jobs:
  build-and-test:
    name: Create XCFramework
    runs-on: macos-latest
  
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install ccache
        run: |
          mkdir .ccache
          curl -L https://github.com/ccache/ccache/releases/download/v4.8.3/ccache-4.8.3-darwin.tar.gz | tar xz --strip-components=1 -C .ccache
          export PATH=$PWD/.ccache:$PATH
          ccache --version

      - name: Get cache key parts
        id: cache-key-parts
        run: |
          echo "llvm-hash=${{ hashFiles('mlir/llvm') }}" >> $GITHUB_OUTPUT
          echo "circt-hash=${{ hashFiles('mlir/circt') }}" >> $GITHUB_OUTPUT
          echo "repo-hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "cache-key-prefix=\"xcframework-ccache" >> $GITHUB_OUTPUT

      - name: Restore ccache database
        uses: actions/cache/restore@v3
        with: 
          path: ccache
          key: ${{ steps.cache-key-parts.outputs.cache-key-prefix }}-llvm_${{ steps.cache-key-parts.outputs.llvm-hash }}-circt_${{ steps.cache-key-parts.outputs.circt-hash }}-repo_${{ steps.cache-key-parts.outputs.repo-hash }}
          restore-keys: |
            ${{ steps.cache-key-parts.outputs.cache-key-prefix }}-llvm_${{ steps.cache-key-parts.outputs.llvm-hash }}-circt_${{ steps.cache-key-parts.outputs.circt-hash }}-repo_
            ${{ steps.cache-key-parts.outputs.cache-key-prefix }}-llvm_${{ steps.cache-key-parts.outputs.llvm-hash }}-circt_
            ${{ steps.cache-key-parts.outputs.cache-key-prefix }}-llvm_
      
      - name: Initialize ccache
        # We configure ccache to not evict anything during compilation, and we perform a cleanup after compilation completes
        run: |
          date +%s > .workflow-start-seconds
          export CCACHE_DIR=$PWD/ccache
          ccache -M 1600GB
          ccache -sv
          ccache -z

      - name: Install SwiftHDL
        run: |
          export CCACHE_DIR=$PWD/ccache
          ./support/install-target-and-dependencies SwiftHDL

      - name: Create xcframework
        run: |
          ./support/create-xcframework

      - name: Test xcframework
        run: |
          swift test --package-path test-project/TestXCFramework

      - name: Clean up ccache and log stats
        uses: devcontainers/ci@v0.3
        with:
          push: never
          runCmd: |
            export CCACHE_DIR=$PWD/ccache
            ccache -sv
            ccache -M 1GB
            ccache --cleanup
            ccache -sv

      # Save the cache prior to pruning it. We save the cache unconditionally since installing SwiftHDL may have made meaningful progress even if it eventually failed.
      - name: Save ccache database
        uses: actions/cache/save@v3
        if: always()
        with: 
          path: ccache
          key: ${{ steps.cache-key-parts.outputs.cache-key-prefix }}-llvm_${{ steps.cache-key-parts.outputs.llvm-hash }}-circt_${{ steps.cache-key-parts.outputs.circt-hash }}-repo_${{ steps.cache-key-parts.outputs.repo-hash }}

      # If evicting everything that wasn't used this workflow does not reduce the cache past its maximum, it may benefit performance to increase the cache size.
      - name: Log ccache estimated usage
        uses: devcontainers/ci@v0.3
        with:
          push: never
          runCmd: |
            export CCACHE_DIR=$PWD/ccache
            ccache --evict-older-than $(($(date +%s) - $(cat .workflow-start-seconds)))s
            ccache -sv
            rm .workflow-start-seconds
      
      - name: Check that repository is clean
        uses: devcontainers/ci@v0.3
        with:
          push: never
          runCmd: |
            git diff --exit-code
